<mat-sidenav-container class="meta-metrics-viewer-container">

  <mat-sidenav [(opened)]="sidenavOpened" mode="side" position="end" fixedInViewport="true" class="mat-sidenav-details">
    <button mat-icon-button (click)="sidenavOpened = false" class="mat-close-button">
      <mat-icon>close</mat-icon>
    </button>
    <app-meta-metrics-viewer-details *ngIf="selectedRow && selectedRange"
            [sublicense]="selectedRow.sublicense"
            [measurements]="(selectedRowMeasurements$ | async)"
            [range]="selectedRange">
    </app-meta-metrics-viewer-details>
  </mat-sidenav>

  <mat-sidenav-content>
    <app-header fxLayoutAlign="space-between start">
      <div style="margin-left: 15px;">
        <button mat-mini-fab aria-label="map" (click)="goToMap()">
          <mat-icon aria-hidden="false" aria-label="Example home icon">add_location</mat-icon>
        </button>
      </div>

      <mat-form-field class="filter">
        <mat-label>Filter</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="-- installation name (sublicense) --" #input>
      </mat-form-field>
      <span class="spacer"></span>
      <mat-form-field appearance="standard">
        <mat-label>Range</mat-label>
        <mat-select [(value)]="selectedRange" (selectionChange)="changeFilters($event)">
          <mat-option></mat-option>
          <mat-option [value]="option" *ngFor="let option of ranges">{{ option.display }}</mat-option>
        </mat-select>
      </mat-form-field>

      <div style="margin-left: 15px;">
        <button mat-raised-button *ngIf="!loginDisplay" (click)="login()">Login</button>
        <button mat-raised-button color="accent" *ngIf="loginDisplay" (click)="logout()">Logout</button>
      </div>
    </app-header>

    <div>
      <cdk-virtual-scroll-viewport bufferMultiplier="bufferMultiplier" tvsItemSize="150" class="main-viewport">
        <div id="filter-panel">
          <mat-form-field appearance="standard">
            <mat-label>License</mat-label>
            <mat-select [(value)]="filterLicense" (selectionChange)="changeFilters($event)">
              <mat-option></mat-option>
              <mat-option [value]="option" *ngFor="let option of modelFilters.licenses">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="standard">
            <mat-label>Version</mat-label>
            <mat-select [(value)]="filterVersion" (selectionChange)="changeFilters($event)">
              <mat-option></mat-option>
              <mat-option [value]="option" *ngFor="let option of modelFilters.versions">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="standard">
            <mat-label>App</mat-label>
            <mat-select [(value)]="filterApp" (selectionChange)="changeFilters($event)">
              <mat-option></mat-option>
              <mat-option [value]="option" *ngFor="let option of modelFilters.apps">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="standard">
            <mat-label>Environment</mat-label>
            <mat-select [(value)]="filterEnvironment" (selectionChange)="changeFilters($event)">
              <mat-option></mat-option>
              <mat-option [value]="option" *ngFor="let option of modelFilters.environments">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="standard">
            <mat-label>Project</mat-label>
            <mat-select [(value)]="filterProject" (selectionChange)="changeFilters($event)">
              <mat-option></mat-option>
              <mat-option [value]="option" *ngFor="let option of modelFilters.projects">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="standard">
            <mat-label>Server</mat-label>
            <mat-select [(value)]="filterServer" (selectionChange)="changeFilters($event)">
              <mat-option></mat-option>
              <mat-option [value]="option" *ngFor="let option of modelFilters.servers">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="standard">
            <mat-label>SubLicense</mat-label>
            <mat-select [(value)]="filterSubLicense" (selectionChange)="changeFilters($event)">
              <mat-option></mat-option>
              <mat-option [value]="option" *ngFor="let option of modelFilters.subLicenses">{{ option }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <table mat-table [dataSource]="dataSource">
          <!-- Position Column -->
          <ng-container matColumnDef="position">
            <th mat-header-cell *matHeaderCellDef> No. </th>
            <td mat-cell *matCellDef="let element; let i = index"> {{element.position}} </td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="installation">
            <th class="c-p" mat-header-cell *matHeaderCellDef (click)="sortColumn('name')"> Name </th>
            <td mat-cell *matCellDef="let element"> {{element.installation.sublicense}} </td>
          </ng-container>

          <!-- bis Column -->
          <ng-container matColumnDef="bis">
            <th mat-header-cell *matHeaderCellDef> bis </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.installation?.lastTimestamp || (element.installationRequest | async); else elseBlock">
                {{element.installation?.lastTimestamp | date:'dd.MM. HH:mm'}}
              </div>
              <ng-template #elseBlock>
                <app-spinner></app-spinner>
              </ng-template>
            </td>
          </ng-container>

          <ng-container [matColumnDef]="column.id" *ngFor="let column of dynamicColumns; let i = index">
            <th mat-header-cell *matHeaderCellDef>
              <mat-form-field appearance="outline">
                <mat-select [(value)]="column.measurement" (selectionChange)="dynamicColumnsHeaderChange($event, i)">
                  <mat-option *ngFor="let measureItem of measurements" [value]="measureItem">
                    {{measureItem.measurementDisplay}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </th>
            <td mat-cell *matCellDef="let element" class="mat-dynamic-column">
              <span *ngIf="element.array4Lines.length>0; else elseBlock">
                <app-line-chart [measurement]="column.measurement"
                                [array4Lines]="element.array4Lines">
                </app-line-chart>
              </span>
              <ng-template #elseBlock>
                <span *ngIf="!element.isSpinner">
                  <app-spinner></app-spinner>
                </span>
              </ng-template>
            </td>
          </ng-container>

          <!-- Server Column -->
          <ng-container matColumnDef="server">
            <th mat-header-cell *matHeaderCellDef> Server </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.dynamicRequest | async">
                <span *ngIf="element.array4Lines.length>0">
                  {{element.array4Lines[0].server}}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Server Version -->
          <ng-container matColumnDef="version">
            <th mat-header-cell *matHeaderCellDef> Version </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.array4Lines.length>0">
                {{element.array4Lines[0].version}}
              </div>
            </td>
          </ng-container>

          <!-- Server License -->
          <ng-container matColumnDef="license">
            <th mat-header-cell *matHeaderCellDef> License </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.array4Lines.length>0">
                {{element.array4Lines[0].license}}
              </div>
            </td>
          </ng-container>

          <!-- Server App -->
          <ng-container matColumnDef="app">
            <th mat-header-cell *matHeaderCellDef> App </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.array4Lines.length>0">
                {{element.array4Lines[0].app}}
              </div>
            </td>
          </ng-container>

          <!-- Server Environment -->
          <ng-container matColumnDef="env">
            <th mat-header-cell *matHeaderCellDef> Environment </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.array4Lines.length>0">
                {{element.array4Lines[0].env}}
              </div>
            </td>
          </ng-container>

          <!-- Server Sublicense -->
          <ng-container matColumnDef="sublicense">
            <th mat-header-cell *matHeaderCellDef> Sublicense </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.array4Lines.length>0">
                {{element.array4Lines[0].sublicense}}
              </div>
            </td>
          </ng-container>

          <!-- Server Project -->
          <ng-container matColumnDef="project">
            <th mat-header-cell *matHeaderCellDef> Project </th>
            <td mat-cell *matCellDef="let element">
              <div *ngIf="element.array4Lines.length>0">
                {{element.array4Lines[0].project}}
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns; let i = index;" (click)="onClickRow(row, i)"
              [ngClass]="seeShow(row)"></tr>
        </table>
      </cdk-virtual-scroll-viewport>
    </div>
  </mat-sidenav-content>

</mat-sidenav-container>
